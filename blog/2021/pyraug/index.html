<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="K8iQXKj8_YwAKThxuRBM8cv5uQgM7Jyq8gCzFFWqEGA" />

<title>Clément  Chadebec | Pyraug Case Study 1</title>
<meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design.
">

<!-- Open Graph -->


<!-- Bootstrap & MDB -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css" integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

<!-- Code Syntax Highlighting -->
<link rel="stylesheet" href="https://gitcdn.link/repo/jwarby/jekyll-pygments-themes/master/github.css" />

<!-- Styles -->

<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22></text></svg>">

<link rel="stylesheet" href="/assets/css/main.css">

<link rel="canonical" href="/blog/2021/pyraug/">

<!-- JQuery -->
<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>


<!-- Theming-->

  <script src="/assets/js/theme.js"></script>
  <!-- Load DarkMode JS -->
<script src="/assets/js/dark_mode.js"></script>






    
<!-- MathJax -->
<script type="text/javascript">
  window.MathJax = {
    tex: {
      tags: 'ams'
    }
  };
</script>
<script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
<script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>


    <script src="/assets/js/distillpub/template.v2.js"></script>
    <script src="/assets/js/distillpub/transforms.v2.js"></script>
    
    <style type="text/css">
      .fake-img {
  background: #bbb;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 0px 4px rgba(0, 0, 0, 0.1);
  margin-bottom: 12px;
} .fake-img p {
  font-family: monospace;
  color: white;
  text-align: left;
  margin: 12px 0;
  text-align: center;
  font-size: 16px;
}

    </style>
    
  </head>

  <d-front-matter>
    <script async type="text/json">{
      "title": "Pyraug Case Study 1",
      "description": "Use of Pyraug software to perform MRI classification",
      "published": "July 12, 2021",
      "authors": [
        
        {
          "author": "Clément Chadebec",
          "authorURL": "",
          "affiliations": [
            {
              "name": "Université de Paris, INRIA",
              "url": ""
            }
          ]
        }
        
      ],
      "katex": {
        "delimiters": [
          {
            "left": "$",
            "right": "$",
            "display": false
          },
          {
            "left": "$$",
            "right": "$$",
            "display": true
          }
        ]
      }
    }</script>
  </d-front-matter>

  <body class="fixed-top-nav ">

    <!-- Header -->

    <header>

    <!-- Nav Bar -->
    <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
    <div class="container">
      
      <a class="navbar-brand title font-weight-lighter" href="/">
       <span class="font-weight-bold">Clément</span>   Chadebec
      </a>
      
      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>
      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">
              about
              
            </a>
          </li>
          
          <!-- Blog -->
          <li class="nav-item active">
            <a class="nav-link" href="/blog/">
              blog
              
            </a>
          </li>
          
          <!-- Other pages -->
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/projects/">
                projects
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/research/">
                research
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/teaching/">
                teaching
                
              </a>
          </li>
          
          
          
            <div class = "toggle-container">
              <a id = "light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
              </a>
            </div>
          
        </ul>
      </div>
    </div>
  </nav>

</header>


    <!-- Content -->

    <div class="post distill">

      <d-title>
        <h1>Pyraug Case Study 1</h1>
        <p>Use of Pyraug software to perform MRI classification</p>
      </d-title>

      <d-byline></d-byline>

      <d-article>
        <h2 id="case-study-1-classification-on-3d-mri-adni--aibl">Case Study 1: Classification on 3D MRI (ADNI &amp; AIBL)</h2>

<h3 id="introduction">Introduction</h3>

<p align="justify" style="text-align:justify"> 
A Riemannian Hamiltonian VAE model <d-cite key="chadebec_geometry-aware_2020"></d-cite> and <a href="https://github.com/clementchadebec/pyraug" target="blank">Pyraug software</a> were used to perform Data Augmentation in the High Dimensional Low Sample Size Setting on 3D MRI neuroimaging data from <a href="http://adni.loni.usc.edu/" target="blank">ADNI database</a>. The model was used to try to enhance the classification task consisting in finding Alzheimer's disease patients (AD) from Cognitively Normal participants (CN) using T1-weighted MR images <d-cite key="chadebec_data_2021"></d-cite>.  such augmentation.
</p>

<h3 id="classification-set-up">Classification set up</h3>

<h4 id="data-splitting">Data Splitting</h4>

<p align="justify">The ADNI data set was split into 3 sets: train, validation and test.
First, the test set was created using 100 randomly chosen participants for each diagnostic label (i.e. 100 CN, 100 AD). The rest of the data set was split such that 80% is allocated from training and 20% for validation. The authors ensured that age, sex and site distributions between the three sets were not significantly different. The train set is referred to as <i>train-full</i> in the following.

In addition, a smaller training set (denoted as <i>train-50</i>) was extracted from <i>train-full</i>. This set comprised only 50 images per diagnostic label, instead of 243 CN and 210 AD for <i>train-full</i>. It was ensured that age and sex distributions between <i>train-50</i> and <i>train-full</i> were not significantly different. This was not done for the site distribution as there are more than 50 sites in the ADNI data set (so they could not all be represented in this smaller training set). The AIBL data was <b>never used for training</b> or hyperparameter tuning and was only used as an <b>independent</b> test set.
</p>
<div class="img">
    <div class="col-sm mt-0 mt-md-0">
        <img class="img-fluid rounded z-depth-1" src="/assets/img/pyraug_project/Case_study_1.jpg" alt="" title="Data Splitting" />
    </div>
</div>
<div class="caption">
     Data Split for the classification task: Alzheimer Disease (AD) vs. Cognitively Normal (CN)
</div>

<h4 id="data-processing">Data Processing</h4>

<p>All the data was processed as follows:</p>
<dl>
  <li> Raw data are converted to the BIDS standard <d-cite key="gorgolewski_brain_2016"></d-cite>.</li>
  <li> Bias field correction is applied using N4ITK <d-cite key="tustison_n4itk_2010"></d-cite>.</li>
  <li> T1w images are linearly registered to the MNI standard space <d-cite key="fonov_unbiased_2009"></d-cite> with ANTS <d-cite key="avants_insight_2014"></d-cite> and cropped. This produced images of size 169x208x179 with 1mm3 isotropic voxels.</li>
  <li> An automatic quality check is performed using an open-source pretrained network <d-cite key="fonov_deep_2018"></d-cite>. All images passed the quality check.</li>
  <li> NIfTI files are converted to tensor format.</li>
  <li> (Optional) Images are down-sampled using a trilinear interpolation, leading to an image size of 84x104x89.</li>
  <li> Intensity rescaling between the minimum and maximum values of each image is performed.</li>
</dl>

<h4 id="classifier">Classifier</h4>

<p align="justify">
To perform such classification task a CNN was used with two different paradigms to choose the architecture. First, the authors reused the same architecture as in <d-cite key="wen_convolutional_2020"></d-cite> which was obtained by optimizing manually the networks on the ADNI data set for the same task (AD vs CN). A slight adaption was done for the down-sampled images, which consisted in resizing the number of nodes in the fully-connected layers to keep the same ratio between the input and output feature maps in all layers. This  architecture is denoted <b>baseline</b>. Secondly, a random search was launched  <d-cite key="bergstra_random_2012"></d-cite> allowing to explore different hyperperameter values. The hyperparameters explored for the architecture were the number of convolutional blocks, of filters in the first layer and of convolutional layers in a block, the number of fully-connected layers and the dropout rate. Other hyperparameters such as the learning rate and the weight decay were also part of the search. 100 different random architectures were trained on the 5-fold cross-validation done on <i>train-full</i>. For each input, the selected  architecture is the one that obtained the best mean balanced accuracy across the validation sets of the cross-validation. This architecture is referred to as <b>optimized</b>.</p>
<div class="img">
    <div class="col-sm mt-0 mt-md-0">
        <img class="img-fluid rounded z-depth-1" src="/assets/img/pyraug_project/CNNs.jpeg" alt="" title="CNN Networks" />
    </div>
</div>
<div class="caption">
    CNN architectures: <i>left</i>: The baseline net. <i>right</i>: The optimized one using a random search across100 architectures.
</div>

<h4 id="augmentation-set-up">Augmentation Set up</h4>

<p align="justify">
On the meantime, a RHVAE was trained on each class of the train sets (<i>train-50</i> or <i>train-full</i>) to be able to generate new synthetic data. Noteworthy is the fact that the VAE and the CNN shared the <b>same training set</b> and no augmentation was performed on the validation set or the test set.
</p>

<div class="img">
    <div class="col-sm mt-0 mt-md-0">
        <img class="img-fluid rounded z-depth-1" src="/assets/img/pyraug_project/DA_diagram.png" alt="" title="DA framework" />
    </div>
</div>
<div class="caption">
    Data Augmentation scheme with a VAE.
</div>

<p align="justify">
Then the <b>baseline</b> (resp. <b>optimized</b>) CNN networks were then trained for 100 (resp. 50) epochs using the cross entropy loss for training and validation losses. Balanced accuracy was also computed at the end of each epoch. The models were trained on either 1) only the <i>real</i> images; 2) only the synthetic samples created by the RHVAE or 3) the augmented training set (<i>real</i> + synthetic) on 20 independent runs for each experiment. The final model  was chosen as the one that obtained the highest validation balanced accuracy during training.  
</p>

<h4 id="results">Results</h4>

<p align="justify">
Below are presented some of the main results obtained in this case study. We refer the reader to <d-cite key="chadebec_data_2021"></d-cite> for the full results of the study.
<div class="container">
  <input type="checkbox" id="zoomCheck1" />
    <label for="zoomCheck1">
        <img class="img-fluid rounded z-depth-1" src="/assets/img/pyraug_project/baseline_results.png" alt="zoom" title="Classification results" />
    </label>
</div>
<div class="caption">
    Augmentation results with the <b>baseline</b> CNN network.
</div>


<div class="container">
  <input type="checkbox" id="zoomCheck2" />
    <label for="zoomCheck2">
        <img class="img-fluid rounded z-depth-1" src="/assets/img/pyraug_project/optimized_results.png" alt="zoom" title="Classification results" />
    </label>
</div>
<div class="caption">
    Augmentation results with the <b>optimized</b> CNN network.
</div>

<p align="justify">
<a href="https://github.com/clementchadebec/pyraug" target="blank">Pyraug software</a> allowed for a significant gain in the model classification results even when the CNN was optimized on the real data only (random search not performed for augmented data set) and even though small size data sets were considered along with very challenging high dimensional data.
</p>
</p>

      </d-article>

      <d-appendix>
        <d-footnote-list></d-footnote-list>
        <d-citation-list></d-citation-list>
      </d-appendix>

    </div>

    <!-- Footer -->

    
<footer class="fixed-bottom">
  <div class="container mt-0">
    &copy; Copyright 2022 Clément  Chadebec.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>.

    
    
  </div>
</footer>



  </body>

  <d-bibliography src="/assets/bibliography/references.bib">
  </d-bibliography>

</html>
